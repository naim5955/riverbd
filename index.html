<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>River NDVI / NDWI Explorer</title>

    <!-- Leaflet core -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha512-p8OCdbYtPI0lzT2Ujag6rgIGb5gxBfXWlPgWd9I3eVNcqJ2cbunC9261qRUfU56R+zWl5BD7s8YsmA6JzDyDag=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha512-pMwrGmX1mPPxxbeq42adYB60J8oHJJRZ9j70F23aJk9NQ7FlUhJ/DXYBbG3Fkae8mtoraxwqNagu8Lb4pqdRoQ=="
      crossorigin=""
    ></script>

    <!-- Tailwind for quick styling (optional) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

    <style>
      #map {
        height: 80vh;
      }
    </style>
  </head>
  <body class="bg-gray-50 p-4">
    <h1 class="text-2xl font-bold mb-4">River NDVI / NDWI Explorer</h1>

    <!-- Controls -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
      <select id="river" class="p-2 rounded bg-white shadow">
        <option value="padma">Padma</option>
        <!-- Add more rivers here (jamuna, meghna…) -->
      </select>

      <select id="year" class="p-2 rounded bg-white shadow">
        <option value="2022">2022</option>
        <!-- Add more years here -->
      </select>

      <select id="quarter" class="p-2 rounded bg-white shadow">
        <option value="Q1">Q1</option>
        <option value="Q2">Q2</option>
        <option value="Q3">Q3</option>
        <option value="Q4">Q4</option>
      </select>

      <select id="index" class="p-2 rounded bg-white shadow">
        <option value="NDVI">NDVI</option>
        <option value="NDWI">NDWI</option>
      </select>

      <button id="load" class="bg-blue-600 text-white rounded px-4 py-2 flex items-center justify-center shadow">
        <span class="mr-2">Load Layer</span>
        <svg id="loader" class="animate-spin h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.536-3.536A9 9 0 103.464 15.536L7 12H4z"></path></svg>
      </button>
    </div>

    <!-- Map container -->
    <div id="map" class="rounded shadow"></div>

    <!-- Main script -->
    <script>
      // ---------------- Map setup ----------------
      const map = L.map("map").setView([23.7, 90.35], 7); // Bangladesh

      const street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      const satellite = L.tileLayer(
        "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { attribution: "© Esri & contributors" }
      );

      L.control.layers({ Street: street, Satellite: satellite }, null, { position: "topright" }).addTo(map);

      // -------------- Global state ----------------
      let overlay = null;          // Currently-displayed PNG overlay
      let metadata = {};           // Loaded from png_metadata.json

      // -------------- Helpers ----------------
      function toggleLoader(show) {
        document.getElementById("loader").classList[show ? "remove" : "add"]("hidden");
      }

      async function loadMetadata() {
        try {
          const res = await fetch("png_metadata.json");
          metadata = await res.json();
        } catch (err) {
          console.error("Could not load png_metadata.json", err);
          alert("metadata file missing. Make sure png_metadata.json is in repo root.");
        }
      }

      // -------------- Event listeners ----------------
      document.getElementById("load").addEventListener("click", () => {
        const river   = document.getElementById("river").value;
        const year    = document.getElementById("year").value;
        const quarter = document.getElementById("quarter").value;
        const index   = document.getElementById("index").value;

        const filename = `${river}_${year}_${quarter}_${index}.png`;
        const info = metadata[filename];

        if (!info) {
          alert(`No metadata for ${filename}. Check naming or metadata file.`);
          return;
        }

        const bounds = info.bounds; // [[southLat, westLon], [northLat, eastLon]]

        // Remove existing overlay
        if (overlay) map.removeLayer(overlay);

        toggleLoader(true);
        overlay = L.imageOverlay(`pngs/${filename}`, bounds, { opacity: 0.75 });
        overlay.addTo(map);
        map.fitBounds(bounds);
        toggleLoader(false);
      });

      // Load metadata once on page load
      loadMetadata();
    </script>
  </body>
</html>
